SHELL = /bin/sh

all: daemonproxy

.SUFFIXES:
.SUFFIXES: .c .o

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
srcdir = @srcdir@/../src
datarootdir = @datarootdir@
sysconfdir = @sysconfdir@
localstatedir = @localstatedir@
runstatedir = $(localstatedir)/run
mandir = @mandir@

daemonproxy_src := fd.c service.c signal.c controller.c Contained_RBTree.c daemonproxy.c log.c strseg.c

CFLAGS = @CFLAGS@ -MMD -MP -O2 -g3 -Wall
CPPFLAGS = @CPPFLAGS@ -I. -I$(srcdir)
LDFLAGS = @LDFLAGS@
LIBS = @LIBS@

-include $(daemonproxy_src:.c=.d)

%.o: $(srcdir)/%.c
	@test -e $(@:.o=.c) || ln -s $< $(@:.o=.c)
	$(CC) -o $@ $(CPPFLAGS) -c $(@:.o=.c) $(CFLAGS)

daemonproxy: $(daemonproxy_src:.c=.o)
	@echo Generating version.c
	@( echo '#include "config.h"'; \
	   echo 'const char *  version_git_tag = "'`git tag | tail -n 1`'";'; \
	   echo 'const int64_t version_build_ts = '`date +%s`';'; \
	   echo 'const char *  version_git_head = "TODO: see Makefile.in";'; \
	) > version.autogen.c
	$(CC) -o version.autogen.o $(CPPFLAGS) -c version.autogen.c $(CFLAGS)
	$(CC) -o $@ $(CPPFLAGS) $^ version.autogen.o $(CFLAGS) $(LDFLAGS) $(LIBS)

controller.o: $(srcdir)/controller_data.autogen.c

$(srcdir)/controller_data.autogen.c: $(srcdir)/controller.c $(srcdir)/generate_controller_data.pl
	perl $(srcdir)/generate_controller_data.pl < $< > $@.tmp && mv $@.tmp $@

signal.o: $(srcdir)/signal_data.autogen.c

$(srcdir)/sig_list.txt:
	perl $(srcdir)/generate_signal_list.pl < $< > $@.tmp && mv $@.tmp $@

$(srcdir)/signal_data.autogen.c: $(srcdir)/sig_list.txt $(srcdir)/signal.c $(srcdir)/generate_signal_data.pl
	$(CPP) - - < $< | perl $(srcdir)/generate_signal_data.pl > $@.tmp && mv $@.tmp $@

install:
	$(INSTALL) -m 755 daemonproxy $(DESTDIR)$(bindir)

clean:
	rm *.autogen.c
	rm *.o
	rm *.d

.PHONY: install test
